<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ecommerce Chat Support</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 90%; width: 500px; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="relative w-full max-w-2xl bg-white shadow-xl rounded-2xl flex flex-col h-[80vh] overflow-hidden">
        <!-- Header -->
        <div class="p-4 border-b border-gray-200 bg-white sticky top-0 z-10 rounded-t-2xl">
            <div class="flex items-center justify-between">
                <div id="chat-header-info" class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">AI</div>
                    <div>
                        <h1 id="chat-title" class="text-xl font-semibold">Ecommerce Chat Support</h1>
                        <p id="chat-subtitle" class="text-sm text-gray-500">How can I assist you today?</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button id="faq-button" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-200 transition-colors duration-200">FAQs</button>
                    <!-- Dashboard button REMOVED as requested -->
                    <button id="agent-button" class="bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-600 transition-colors duration-200">Talk to an Agent</button>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto space-y-4">
            <!-- Initial bot message -->
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.939c-.198-.44-.316-.91-.35-1.4a5.992 5.992 0 011.009-4.22c.38-.636.817-1.22 1.32-1.745-.045.025-.09.05-.135.074C10.603 9.484 9.172 11.235 9 13.064c-.201 2.87 2.115 5.21 4.966 4.943a1.99 1.99 0 001.385-1.579c.07-.464.113-.938.12-1.411.011-.676-.11-1.345-.333-1.986l-.004-.012c-.223-.64-.537-1.218-.887-1.724a.8.8 0 01.442-1.399c1.47-.393 2.822.427 3.33 1.834.457 1.256.457 2.585 0 3.841-1.47 4.026-6.494 4.026-7.964 0zm0 0c.34-.336.711-.643 1.11-.913.045-.03.09-.059.135-.089a.8.8 0 01.442 1.399c-.854.774-1.921 1.2-2.997 1.215-2.87.201-5.21-2.115-4.943-4.966.07-.638.113-1.27.12-1.907.011-1.349-.11-2.678-.333-3.987l-.004-.012c-.223-1.317-.537-2.587-.887-3.722a.8.8 0 01.442-1.399c1.47-.393 2.822.427 3.33 1.834.457 1.256.457 2.585 0 3.841-1.47 4.026-6.494 4.026-7.964 0z" />
                    </svg>
                </div>
                <div class="bg-gray-100 p-3 rounded-xl max-w-md">
                    <p class="text-sm">Hi there! I'm your AI support assistant. Ask about <strong>shipping</strong>, <strong>returns</strong>, <strong>order status</strong>, payments, products, warranties, or store policies.</p>
                </div>
            </div>
        </div>

        <!-- Input and Send Button -->
        <div class="p-4 border-t border-gray-200 bg-white sticky bottom-0 z-10 rounded-b-2xl">
            <div class="relative">
                <input id="message-input" type="text" placeholder="Type your message..." class="w-full pl-4 pr-12 py-3 rounded-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow duration-300 placeholder:text-gray-500" />
                <button id="send-button" class="absolute inset-y-0 right-0 flex items-center justify-center pr-3 group" aria-label="Send message">
                  <div class="p-2 bg-blue-500 rounded-full transition-all duration-200 group-hover:scale-110">
                    <img src="assets/send-icon.png" alt="Send" class="w-6 h-6 object-contain invert-0" />
                  </div>
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="absolute inset-x-0 bottom-40 w-12 h-12 rounded-full mx-auto hidden">
            <div class="h-full w-full rounded-full bg-blue-500 animate-pulse"></div>
        </div>
    </div>

    <!-- FAQ Modal -->
    <div id="faq-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Frequently Asked Questions</h2>
                <button id="close-faq-modal-button" class="text-gray-500 hover:text-gray-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <h3 class="font-bold text-lg mb-1">1. Where is my order?</h3>
                    <p class="text-sm text-gray-700">Track using the number in your shipping confirmation email or just type "track order #&lt;id&gt;" here.</p>
                </div>
                <hr />
                <div>
                    <h3 class="font-bold text-lg mb-1">2. How do I initiate a return?</h3>
                    <p class="text-sm text-gray-700">Type "return #&lt;id&gt;" or visit our Returns Center. Most items are returnable within 30 days.</p>
                </div>
                <hr />
                <div>
                    <h3 class="font-bold text-lg mb-1">3. What is your return policy?</h3>
                    <p class="text-sm text-gray-700">30 days from delivery, new/unused, with original tags & packaging. Some categories may vary.</p>
                </div>
                <hr />
                <div>
                    <h3 class="font-bold text-lg mb-1">4. When will I receive my refund?</h3>
                    <p class="text-sm text-gray-700">Once inspected, refunds are typically processed within 5–7 business days to your original payment method.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * ⚙️ Gemini integration notes
         * - Direct-from-browser calls to Google Generative Language API may face CORS.
         * - For production, proxy via your backend (recommended): POST /api/gemini {message, context}
         * - This file supports both: set USE_DIRECT_GEMINI=true and provide GEMINI_API_KEY, or leave false to use smart local NLU fallback.
         */
        const USE_DIRECT_GEMINI = true; // set to true only if you will call Google's API directly from the browser (dev only)
        const GEMINI_API_KEY = "AIzaSyAi-UipOUFdtj6hRqQHN3Fk8HqzkNVG4Y0";      // dev-only; do NOT ship secrets to the client in production
        const GEMINI_MODEL = "gemini-1.5-flash"; // change to 1.5-pro for higher quality if your quota allows

        // ---- Dummy data for demo ----
        const dummyOrders = [
            { id: '12345', product: 'Wireless Mouse', status: 'Delivered', returnEligibility: true, date: '2025-08-20', carrier: 'UPS', tracking: '1Z999AA10123456784' },
            { id: '67890', product: 'Ergonomic Keyboard', status: 'Delivered', returnEligibility: false, date: '2025-06-15', carrier: 'FedEx', tracking: '781234567890' },
            { id: '11223', product: 'Laptop Stand', status: 'Shipped', returnEligibility: true, date: '2025-09-01', carrier: 'DHL', tracking: 'DHLAW112233' }
        ];

        // Simple Levenshtein distance for typo tolerance
        function levenshtein(a, b) {
            const an = a ? a.length : 0; const bn = b ? b.length : 0;
            if (an === 0) return bn; if (bn === 0) return an;
            const matrix = Array.from({ length: bn + 1 }, () => Array(an + 1).fill(0));
            for (let i = 0; i <= bn; i++) matrix[i][0] = i;
            for (let j = 0; j <= an; j++) matrix[0][j] = j;
            for (let i = 1; i <= bn; i++) {
                for (let j = 1; j <= an; j++) {
                    const cost = b.charAt(i - 1) === a.charAt(j - 1) ? 0 : 1;
                    matrix[i][j] = Math.min(matrix[i-1][j] + 1, matrix[i][j-1] + 1, matrix[i-1][j-1] + cost);
                }
            }
            return matrix[bn][an];
        }

        // Intent patterns (broad coverage + typo tolerance)
        const intents = [
            { name: 'list_orders', patterns: ['previous orders','my orders','order history','show orders','orders','ordets','orderss'] },
            { name: 'track_order', patterns: ['track','tracking','where is my order','order status','shipment','shipping'] },
            { name: 'initiate_return', patterns: ['return','refund','return an item','start a return'] },
            { name: 'return_policy', patterns: ['return policy','refund policy','returns policy'] },
            { name: 'shipping_policy', patterns: ['shipping policy','shipping cost','delivery charges','free shipping'] },
            { name: 'payment_methods', patterns: ['payment methods','how can i pay','pay options'] },
            { name: 'contact', patterns: ['contact','customer service','call you','email support'] },
            { name: 'greeting', patterns: ['hello','hi','hey'] },
        ];

        function fuzzyIncludes(message, target) {
            const msg = message.toLowerCase(); const tgt = target.toLowerCase();
            if (msg.includes(tgt)) return true;
            // allow small typo window
            return levenshtein(msg, tgt) <= Math.max(1, Math.floor(tgt.length * 0.15));
        }

        function detectIntent(message) {
            const m = message.toLowerCase();
            for (const intent of intents) {
                for (const p of intent.patterns) {
                    if (fuzzyIncludes(m, p)) return intent.name;
                }
            }
            // fallbacks with light heuristics
            if (/\b(track|tracking|order\s*#?\d{5,})\b/i.test(m)) return 'track_order';
            if (/\breturn|refund\b/i.test(m)) return 'initiate_return';
            if (/\border\b/i.test(m)) return 'list_orders';
            return 'unknown';
        }

        function findOrderByIdFromMessage(message) {
            const idMatch = message.match(/#?(\d{5,})/);
            if (!idMatch) return null;
            const id = idMatch[1];
            return dummyOrders.find(o => o.id === id) || null;
        }

        function renderOrders(orders) {
            return `<div class="w-full">${orders.map(order => `
                <div class="bg-white p-4 my-2 rounded-xl shadow-md">
                    <p class="font-semibold text-gray-800">Order ID: <span class="text-blue-600">#${order.id}</span></p>
                    <p class="text-sm text-gray-600">Product: ${order.product}</p>
                    <p class="text-sm text-gray-600">Status: ${order.status}</p>
                    <p class="text-sm text-gray-600">Return Eligible: ${order.returnEligibility ? 'Yes' : 'No'}</p>
                </div>`).join('')}</div>`;
        }

        // ---- Local smart fallback (works without Gemini) ----
        async function localSmartNLU(message) {
            const intent = detectIntent(message);
            switch (intent) {
                case 'greeting':
                    return 'Hello! How can I help you today? You can ask me to track an order (e.g., "track #12345"), start a return, or explain shipping and payment options.';
                case 'list_orders':
                    return renderOrders(dummyOrders);
                case 'track_order': {
                    const order = findOrderByIdFromMessage(message);
                    if (order) {
                        return `Order #${order.id} — <strong>${order.status}</strong>. Carrier: ${order.carrier}. Tracking: ${order.tracking}.`;
                    } else {
                        return 'Please share your order ID (e.g., "track #12345") so I can fetch live tracking info.';
                    }
                }
                case 'initiate_return': {
                    const order = findOrderByIdFromMessage(message);
                    if (order) {
                        if (order.returnEligibility) {
                            return `Order #${order.id} is eligible for return. I can create a return label and email it to you. Shall I proceed?`;
                        }
                        return `Sorry, order #${order.id} is outside the 30-day window (delivered on ${order.date}).`;
                    }
                    return 'Most items are returnable within 30 days. Share your order ID (e.g., "return #12345") to start.';
                }
                case 'return_policy':
                    return 'You can return most items within 30 days of delivery, unused and in original packaging. Refunds are issued 5–7 business days after inspection.';
                case 'shipping_policy':
                    return 'Standard shipping is free for orders over $50. Expedited options are available at checkout. Delivery estimates appear on product pages.';
                case 'payment_methods':
                    return 'We accept major credit/debit cards, UPI/NetBanking (where available), PayPal, and Apple Pay.';
                case 'contact':
                    return 'You can reach us at 1-800-555-1234 or support@ecommerce.com. I can also connect you to a live agent from here.';
                default:
                    return "I'm not sure about that yet, but I can help with orders, returns, shipping, payments, and policies. Try asking, for example: ‘Track #11223’.";
            }
        }

        // ---- Direct Gemini call (dev only; prefer backend proxy) ----
        async function directGeminiCall(message, context = {}) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            const systemPrompt = [
                "You are an ecommerce customer support copilot.",
                "Return intents in JSON like {intent: string, orderId?: string, answer?: string}.",
                "Supported intents: list_orders, track_order, initiate_return, return_policy, shipping_policy, payment_methods, contact, greeting, unknown.",
                "If the user asks for tracking and provides an order ID, include orderId.",
            ].join('\n');

            const payload = {
                contents: [
                    { role: 'user', parts: [{ text: systemPrompt + "\nUser: " + message }] }
                ]
            };

            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) throw new Error('Gemini API error');
            const data = await resp.json();
            const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
            // Try to parse JSON block from the model; if not found, fall back.
            let parsed = null;
            try {
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                parsed = jsonMatch ? JSON.parse(jsonMatch[0]) : null;
            } catch (e) {}

            if (!parsed) {
                // If poor structure, just return raw text
                return { intent: 'unknown', answer: text };
            }
            return parsed;
        }

        async function getSmartResponse(message) {
            // 1) Try Gemini (if enabled)
            if (USE_DIRECT_GEMINI && GEMINI_API_KEY) {
                try {
                    const parsed = await directGeminiCall(message);
                    if (parsed.answer) return parsed.answer;
                    // Intent routing using parsed JSON
                    switch (parsed.intent) {
                        case 'greeting':
                            return 'Hello! How can I help you today?';
                        case 'list_orders':
                            return renderOrders(dummyOrders);
                        case 'track_order': {
                            const order = parsed.orderId ? dummyOrders.find(o => o.id === parsed.orderId) : findOrderByIdFromMessage(message);
                            if (order) return `Order #${order.id} — <strong>${order.status}</strong>. Carrier: ${order.carrier}. Tracking: ${order.tracking}.`;
                            return 'Please share your order ID (e.g., "track #12345").';
                        }
                        case 'initiate_return': {
                            const order = parsed.orderId ? dummyOrders.find(o => o.id === parsed.orderId) : findOrderByIdFromMessage(message);
                            if (order) return order.returnEligibility ? `Order #${order.id} is eligible for return. Shall I email you a label?` : `Sorry, order #${order.id} is outside the 30-day window (delivered on ${order.date}).`;
                            return 'Share your order ID (e.g., "return #12345") to begin the return.';
                        }
                        case 'return_policy':
                            return 'You can return most items within 30 days of delivery, unused and in original packaging. Refunds in 5–7 business days after inspection.';
                        case 'shipping_policy':
                            return 'Standard shipping is free over $50; expedited options are available at checkout.';
                        case 'payment_methods':
                            return 'We accept major cards, PayPal, Apple Pay, and UPI/NetBanking (where available).';
                        case 'contact':
                            return 'Reach us at 1-800-555-1234 or support@ecommerce.com. I can also connect you to a live agent here.';
                        default:
                            // Fallback to local router if Gemini is vague
                            return await localSmartNLU(message);
                    }
                } catch (err) {
                    console.warn('Gemini call failed, using local fallback.', err);
                    return await localSmartNLU(message);
                }
            }

            // 2) Local smart NLU (default)
            return await localSmartNLU(message);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const chatContainer = document.getElementById('chat-container');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const agentButton = document.getElementById('agent-button');
            const chatTitle = document.getElementById('chat-title');
            const chatSubtitle = document.getElementById('chat-subtitle');
            const faqButton = document.getElementById('faq-button');
            const faqModal = document.getElementById('faq-modal');
            const closeFaqModalButton = document.getElementById('close-faq-modal-button');

            let isAgentChat = false;

            function addMessage(message, type) {
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex items-start space-x-3 transition-opacity duration-300 ease-in-out opacity-0 ${type === 'user' ? 'justify-end' : 'justify-start'}`;
                const senderIcon = type === 'user' ? '' : `
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.939c-.198-.44-.316-.91-.35-1.4a5.992 5.992 0 011.009-4.22c.38-.636.817-1.22 1.32-1.745-.045.025-.09.05-.135.074C10.603 9.484 9.172 11.235 9 13.064c-.201 2.87 2.115 5.21 4.966 4.943a1.99 1.99 0 001.385-1.579c.07-.464.113-.938.12-1.411.011-.676-.11-1.345-.333-1.986l-.004-.012c-.223-.64-.537-1.218-.887-1.724a.8.8 0 01.442-1.399c1.47-.393 2.822.427 3.33 1.834.457 1.256.457 2.585 0 3.841-1.47 4.026-6.494 4.026-7.964 0z" />
                        </svg>
                    </div>`;

                const isHTML = /^(<div|<p|<ul|<ol|<strong|<em|<span)/.test(message.trim());
                const contentHtml = type === 'user'
                    ? `<div class="bg-blue-500 text-white p-3 rounded-xl max-w-md shadow-md"><p class="text-sm">${message}</p></div>`
                    : `${senderIcon}<div class="bg-gray-100 p-3 rounded-xl max-w-md shadow-md">${isHTML ? message : `<p class="text-sm">${message}</p>`}</div>`;

                messageWrapper.innerHTML = contentHtml;
                chatContainer.appendChild(messageWrapper);
                setTimeout(() => { messageWrapper.style.opacity = '1'; }, 10);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            async function sendMessage() {
                const message = messageInput.value.trim();
                if (message === '' || isAgentChat) return;
                addMessage(message, 'user');
                messageInput.value = '';
                loadingIndicator.classList.remove('hidden');

                const botResponse = await getSmartResponse(message);
                loadingIndicator.classList.add('hidden');
                addMessage(botResponse, 'bot');
            }

            function startAgentChat() {
                if (isAgentChat) return;
                isAgentChat = true;
                addMessage("I'm transferring you to a live agent. One moment, please.", 'bot');
                chatTitle.textContent = 'Live Agent';
                chatSubtitle.textContent = 'A human is now assisting you.';
                agentButton.style.display = 'none';
                messageInput.disabled = true;
                messageInput.placeholder = 'A human agent will reply shortly...';
            }

            function showFaq() { faqModal.style.display = 'flex'; }
            function hideFaq() { faqModal.style.display = 'none'; }

            // Bindings
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
            agentButton.addEventListener('click', startAgentChat);
            faqButton.addEventListener('click', showFaq);
            closeFaqModalButton.addEventListener('click', hideFaq);
        });
    </script>
</body>
</html>




